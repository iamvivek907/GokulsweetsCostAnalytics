<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Restaurant Costing">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2d96a1">
    <meta name="description" content="Restaurant and sweets cost analytics application">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
    <link rel="icon" type="image/svg+xml" href="./icons/icon-192.svg">
    <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192.png">
    <title>Restaurant Profit Analytics</title>
    
    <!-- App Configuration -->
    <script src="./config.js"></script>

    <!-- Runtime configuration override (injected by CI/CD) -->
    <script src="./supabase-config.runtime.js" onerror="console.warn('Runtime config not found - using config.js values')"></script>
    <style>
        /* Base reset */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root{
            --color-bg:#0f0f0f; --color-surface:#1a1a1a; --color-surface-light:#2d2d2d;
            --color-primary:#2d96a1; --color-primary-hover:#3ca8b4; --color-success:#32b8c6;
            --color-error:#ff5459; --color-warning:#ffa500; --color-text:#f5f5f5;
            --color-text-secondary:#a7a9a9; --color-border:#3a3a3a;
            --radius:8px; --radius-lg:12px; --safe-top: max(12px, env(safe-area-inset-top));
            --safe-bottom: max(12px, env(safe-area-inset-bottom));
        }

        html,body {
            height:100%;
            width:100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background:var(--color-bg); color:var(--color-text);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        /* Container layout */
        #app-container{
            display:flex; flex-direction:column; min-height:100vh;
        }

        .header{
            background:var(--color-surface); padding:16px; padding-top:calc(16px + var(--safe-top));
            border-bottom:1px solid var(--color-border); z-index:100;
        }
        .header h1{ font-size:20px; font-weight:600; }

        .content-area{
            flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch;
            padding-bottom: calc(72px + var(--safe-bottom));
            padding-top:12px;
        }

        .tab-content{ display:none; animation:fadeIn .18s ease-in; }
        .tab-content.active{ display:block; }
        @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
        @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
        .spinning { animation: spin 1s linear infinite; display: inline-block; }

        .page-padding{ padding:16px; max-width:1200px; margin:0 auto; }

        .stats-grid{ display:grid; grid-template-columns: repeat(2,1fr); gap:12px; margin-bottom:20px; }
        .stat-card{ background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-lg); padding:12px; text-align:center; }
        .stat-label{ font-size:12px; color:var(--color-text-secondary); text-transform:uppercase; }
        .stat-value{ font-size:20px; font-weight:700; color:var(--color-primary); margin-top:6px; }

        .dishes-list{ display:flex; flex-direction:column; gap:12px; }

        .dish-row{ background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-lg); padding:14px; cursor:pointer; transition:all 0.2s ease; }
        .dish-row:hover{ border-color:var(--color-primary); background:var(--color-surface-light); }
        .dish-name{ font-size:15px; font-weight:600; margin-bottom:10px; color:var(--color-text); }
        .dish-details{ display:flex; gap:16px; flex-wrap:wrap; }
        .detail-item{ display:flex; flex-direction:column; gap:4px; }
        .detail-label{ font-size:11px; color:var(--color-text-secondary); text-transform:uppercase; letter-spacing:0.5px; }
        .detail-value{ font-size:14px; font-weight:700; color:var(--color-text); }
        .profit-margin{ display:inline-block; padding:4px 10px; border-radius:4px; font-size:12px; font-weight:700; background:var(--color-error); color:#fff; }
        .profit-margin.positive{ background:var(--color-success); }

        .form-section{ background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-lg); padding:14px; margin-bottom:16px; }
        .form-section-title{ font-size:13px; font-weight:600; color:var(--color-text-secondary); margin-bottom:10px; letter-spacing:0.5px; text-transform:uppercase; }

        label{ display:block; font-size:13px; margin-bottom:6px; color:var(--color-text); font-weight:500; }

        input,select,textarea{ width:100%; padding:10px 12px; background:var(--color-surface-light); border:1px solid var(--color-border); border-radius:var(--radius); color:var(--Color-text); font-size:14px; font-family:inherit; }
        textarea{ min-height:80px; resize:vertical; }

        .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

        .btn{ padding:10px 14px; border:none; border-radius:var(--radius); font-weight:700; cursor:pointer; }
        .btn-primary{ background:var(--color-primary); color:#fff; }
        .btn-secondary{ background:var(--color-surface-light); color:var(--color-text); border:1px solid var(--color-border); }
        .btn-danger{ background:var(--color-error); color:#fff; }

        .bottom-nav{
            position:fixed; left:0; right:0; bottom:0; background:var(--color-surface); border-top:1px solid var(--color-border);
            display:grid; grid-template-columns:repeat(4,1fr); z-index:200; padding-bottom:max(8px, env(safe-area-inset-bottom));
        }
        .nav-item{ padding:12px 8px; text-align:center; background:none; border:none; color:var(--color-text-secondary); font-size:12px; cursor:pointer; }
        .nav-item.active{ color:var(--color-primary); font-weight:700; }

        table{ width:100%; border-collapse:collapse; font-size:13px; }
        th,td{ padding:10px; border-bottom:1px solid var(--color-border); text-align:left; }
        th{ background:var(--color-surface-light); color:var(--color-text-secondary); font-size:12px; font-weight:700; }

        .modal{ display:none; position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,.45); z-index:300; justify-content:center; align-items:flex-end; padding:20px; padding-top:var(--safe-top); }
        .modal.active{ display:flex; }
        .modal-content{ width:100%; max-width:720px; background:var(--color-surface); border-radius:12px 12px 8px 8px; padding:16px; max-height:80vh; overflow:auto; }

        .empty-state{ text-align:center; padding:28px 10px; color:var(--color-text-secondary); }

        /* Responsive tweaks */
        @media (max-width: 700px) {
            .stats-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .modal-content { border-radius:12px; max-width:100%; padding:14px; }
            .header h1 { font-size:18px; }
            th, td { font-size:13px; padding:8px; }
        }

        @media (min-width: 900px) {
            .page-padding { padding:24px; }
            .stats-grid { grid-template-columns: repeat(4,1fr); }
        }

        /* improved scrollbar for desktop */
        ::-webkit-scrollbar{ width:8px; height:8px; }
        ::-webkit-scrollbar-track{ background:transparent; }
        ::-webkit-scrollbar-thumb{ background:var(--color-border); border-radius:6px; }

        /* PWA Update Banner */
        #update-banner{
            display:none; position:fixed; top:0; left:0; right:0; z-index:1000;
            background:var(--color-primary); color:#fff; padding:12px 16px;
            box-shadow:0 2px 8px rgba(0,0,0,0.3);
        }
        #update-banner.show{ display:flex; justify-content:space-between; align-items:center; }
        #update-banner button{ background:#fff; color:var(--color-primary); border:none; padding:8px 16px; border-radius:6px; font-weight:700; cursor:pointer; }
        #update-banner button:hover{ opacity:0.9; }

        /* Cloud Sync UI */
        .sync-status{ display:inline-block; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:700; margin-left:8px; }
        .sync-status.success{ background:rgba(50,184,198,0.2); color:var(--color-success); }
        .sync-status.error{ background:rgba(255,84,89,0.2); color:var(--color-error); }

        /* Authentication Screen */
        #auth-screen{
            display:none; /* Hidden by default, shown when not authenticated */
            position:fixed; top:0; left:0; right:0; bottom:0;
            background:var(--color-bg); z-index:999;
            justify-content:center; align-items:center;
            padding:20px;
        }
        .auth-container{
            width:100%; max-width:420px; background:var(--color-surface);
            border-radius:var(--radius-lg); padding:32px;
            border:1px solid var(--color-border);
        }
        .auth-logo{
            text-align:center; font-size:48px; margin-bottom:16px;
        }
        .auth-title{
            text-align:center; font-size:24px; font-weight:700;
            margin-bottom:8px; color:var(--color-text);
        }
        .auth-subtitle{
            text-align:center; font-size:14px; color:var(--color-text-secondary);
            margin-bottom:24px;
        }
        .auth-form{
            display:flex; flex-direction:column; gap:16px;
        }
        .auth-form input{
            width:100%; padding:12px 16px; background:var(--color-surface-light);
            border:1px solid var(--color-border); border-radius:var(--radius);
            color:var(--color-text); font-size:15px;
        }
        .auth-form input:focus{
            outline:none; border-color:var(--color-primary);
        }
        .auth-form button[type="submit"]{
            width:100%; padding:14px; background:var(--color-primary);
            color:#fff; border:none; border-radius:var(--radius);
            font-size:16px; font-weight:700; cursor:pointer;
            transition:background 0.2s ease;
        }
        .auth-form button[type="submit"]:hover{
            background:var(--color-primary-hover);
        }
        .auth-form button[type="submit"]:disabled{
            opacity:0.5; cursor:not-allowed;
        }
        .auth-toggle{
            text-align:center; margin-top:20px; font-size:14px;
            color:var(--color-text-secondary);
        }
        .auth-toggle a{
            color:var(--color-primary); text-decoration:none;
            font-weight:600; cursor:pointer;
        }
        .auth-toggle a:hover{
            text-decoration:underline;
        }
        #auth-error{
            display:none; padding:12px; background:rgba(255,84,89,0.1);
            border:1px solid var(--color-error); border-radius:var(--radius);
            color:var(--color-error); font-size:14px; text-align:center;
            margin-bottom:16px;
        }

        /* Header User Info */
        .header-content{
            display:flex; justify-content:space-between; align-items:center;
        }
        #user-email{
            display:none; font-size:12px; color:var(--color-text-secondary);
            margin-right:8px;
        }
        #logout-btn{
            display:none; padding:6px 12px; background:var(--color-surface-light);
            border:1px solid var(--color-border); border-radius:6px;
            color:var(--color-text); font-size:12px; cursor:pointer;
            transition:all 0.2s ease;
        }
        #logout-btn:hover{
            background:var(--color-error); color:#fff; border-color:var(--color-error);
        }
    </style>
</head>
<body>
    <!-- PWA Update Banner -->
    <div id="update-banner">
        <span>üéâ A new version is available!</span>
        <button onclick="updateApp()">Update Now</button>
    </div>

    <!-- Authentication Screen -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="auth-logo">üçΩÔ∏è</div>
            <h1 class="auth-title">Gokul Sweets Analytics</h1>
            <p class="auth-subtitle">Secure your recipes and data</p>

            <div id="auth-error"></div>

            <!-- Login Form -->
            <div id="login-form" style="display:block;">
                <form class="auth-form" onsubmit="event.preventDefault(); window.handleLogin && window.handleLogin();">
                    <input 
                        type="email" 
                        id="login-email" 
                        placeholder="Email address" 
                        required 
                        autocomplete="email"
                    >
                    <input 
                        type="password" 
                        id="login-password" 
                        placeholder="Password" 
                        required 
                        autocomplete="current-password"
                        minlength="6"
                    >
                    <button type="submit" id="login-submit">Login</button>
                </form>
                <div class="auth-toggle">
                    <span>Don't have an account? </span>
                    <a id="mode-toggle" onclick="window.AuthUI && window.AuthUI.toggleMode()">Sign up</a>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" style="display:none;">
                <form class="auth-form" onsubmit="event.preventDefault(); window.handleSignup && window.handleSignup();">
                    <input 
                        type="email" 
                        id="signup-email" 
                        placeholder="Email address" 
                        required 
                        autocomplete="email"
                    >
                    <input 
                        type="password" 
                        id="signup-password" 
                        placeholder="Password (min 6 characters)" 
                        required 
                        autocomplete="new-password"
                        minlength="6"
                    >
                    <input 
                        type="password" 
                        id="signup-confirm-password" 
                        placeholder="Confirm password" 
                        required 
                        autocomplete="new-password"
                        minlength="6"
                    >
                    <button type="submit" id="signup-submit">Sign Up</button>
                </form>
                <div class="auth-toggle">
                    <span>Already have an account? </span>
                    <a onclick="window.AuthUI.toggleMode()">Login</a>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container">
        <div class="header">
            <div class="header-content">
                <h1 id="page-title">Dashboard</h1>
                <div style="display:flex; align-items:center;">
                    <span id="user-email"></span>
                    <button id="logout-btn" onclick="window.handleLogout && window.handleLogout()">Logout</button>
                </div>
            </div>
        </div>

        <div class="content-area">
            <!-- DASHBOARD -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="page-padding">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Recipes</div>
                            <div class="stat-value" id="stat-recipes">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Profit %</div>
                            <div class="stat-value" id="stat-avg-profit">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Staff</div>
                            <div class="stat-value" id="stat-total-staff">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">At Risk</div>
                            <div class="stat-value" id="stat-red-dishes" style="color:var(--color-error);">0</div>
                        </div>
                    </div>

                    <div style="margin-top:12px;">
                        <h2 style="font-size:15px; margin-bottom:10px;">Your Dishes</h2>
                        <div id="dashboard-dishes-list" class="dishes-list">
                            <div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-title">No dishes yet</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INGREDIENTS -->
            <div id="ingredients-tab" class="tab-content">
                <div class="page-padding">
                    <div class="form-section">
                        <div class="form-section-title">Add New Ingredient</div>
                        <div class="form-group">
                            <label>Ingredient Name</label>
                            <input type="text" id="ingredient-name" placeholder="e.g., Milk, Paneer, Sugar">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Unit</label>
                                <select id="ingredient-unit">
                                    <option value="kg">kg</option>
                                    <option value="L">L</option>
                                    <option value="gm">gm</option>
                                    <option value="pc">pc</option>
                                    <option value="box">box</option>
                                    <option value="bottle">bottle</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Price per Unit (‚Çπ)</label>
                                <input type="number" id="ingredient-price" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        <div style="margin-top:8px;">
                            <button class="btn btn-primary" onclick="addIngredient()">Add Ingredient</button>
                        </div>
                    </div>

                    <div>
                        <h2 style="font-size:15px; margin-bottom:10px;">Raw Materials Library</h2>
                        <div style="overflow-x:auto;">
                            <table>
                                <thead>
                                    <tr><th>Name</th><th>Unit</th><th>Price</th><th>Action</th></tr>
                                </thead>
                                <tbody id="ingredients-table-body"></tbody>
                            </table>
                        </div>
                        <div id="ingredients-empty" class="empty-state" style="display:none;"><div class="empty-state-icon">üì¶</div><div class="empty-state-title">No ingredients yet</div></div>
                    </div>
                </div>
            </div>

            <!-- RECIPES -->
            <div id="recipes-tab" class="tab-content">
                <div class="page-padding">
                    <div class="form-section">
                        <div class="form-section-title">Create Recipe</div>
                        <div class="form-group">
                            <label>Dish Name</label>
                            <input type="text" id="recipe-name" placeholder="e.g., Paneer Tikka">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Category</label>
                                <select id="recipe-category">
                                    <option value="restaurant">üçΩÔ∏è Restaurant</option>
                                    <option value="sweets">üç¨ Sweets</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Selling Price (‚Çπ)</label>
                                <input type="number" id="recipe-selling-price" placeholder="0.00" step="0.01">
                            </div>
                        </div>

                        <div class="form-row" style="margin-top:10px;">
                            <div class="form-group">
                                <label>Wastage %</label>
                                <input type="number" id="recipe-wastage" placeholder="0" min="0" max="100" step="0.1" value="10">
                            </div>
                            <div class="form-group">
                                <label>Daily Production</label>
                                <input type="number" id="recipe-daily-volume" placeholder="50" min="1" step="1" value="50">
                            </div>
                        </div>

                        <div class="form-section" style="margin-top:12px;">
                            <div class="form-section-title">Recipe Ingredients</div>
                            <div id="recipe-ingredients-list" style="margin-bottom:12px;"></div>
                            <div style="margin-top:8px;">
                                <button class="btn btn-secondary" onclick="openIngredientSelector()">+ Add Ingredient</button>
                            </div>
                        </div>

                        <div id="recipe-cost-preview" class="form-section" style="background:rgba(50,184,198,0.04); border-color:var(--color-primary);">
                            <div style="font-size:12px; color:var(--color-text-secondary); margin-bottom:10px; font-weight:600;">üìä COST BREAKDOWN</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; font-size:12px;">
                                <div style="background:var(--color-surface); padding:10px; border-radius:6px;">
                                    <div style="color:var(--color-text-secondary); font-size:11px;">Raw Cost</div>
                                    <div style="font-weight:700; font-size:14px;" id="preview-raw-cost">‚Çπ0.00</div>
                                </div>
                                <div style="background:var(--color-surface); padding:10px; border-radius:6px;">
                                    <div style="color:var(--color-text-secondary); font-size:11px;">Wastage</div>
                                    <div style="font-weight:700; font-size:14px; color:var(--color-warning);" id="preview-wastage-cost">‚Çπ0.00</div>
                                </div>
                                <div style="background:var(--color-surface); padding:10px; border-radius:6px;">
                                    <div style="color:var(--color-text-secondary); font-size:11px;">Labour</div>
                                    <div style="font-weight:700; font-size:14px; color:var(--color-primary);" id="preview-labour-cost">‚Çπ0.00</div>
                                </div>
                                <div style="background:var(--color-surface); padding:10px; border-radius:6px;">
                                    <div style="color:var(--color-text-secondary); font-size:11px;">Utilities</div>
                                    <div style="font-weight:700; font-size:14px; color:var(--color-primary);" id="preview-utilities-cost">‚Çπ0.00</div>
                                </div>
                            </div>
                            <div style="background:var(--color-surface-light); padding:12px; border-radius:6px; font-size:12px;">
                                <div style="display:flex; justify-content:space-between; font-weight:700; color:var(--color-primary);">
                                    <span>TOTAL MAKING COST:</span>
                                    <span id="preview-total-cost">‚Çπ0.00</span>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:12px;">
                            <button class="btn btn-primary" onclick="saveRecipe()">Save Recipe</button>
                        </div>
                    </div>

                    <div style="margin-top:10px;">
                        <h2 style="font-size:15px; margin-bottom:10px;">Your Recipes</h2>
                        <div id="recipes-list" class="dishes-list">
                            <div class="empty-state"><div class="empty-state-icon">üçΩÔ∏è</div><div class="empty-state-title">No recipes yet</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS -->
            <div id="settings-tab" class="tab-content">
                <div class="page-padding">
                    <div class="form-section">
                        <div class="form-section-title">üè™ SHOP/RESTAURANT LOCATION</div>
                        <p style="font-size:11px; color:var(--color-text-secondary); margin-bottom:10px;">Costs for main dishes (Paneer Tikka, Curries, etc.)</p>
                        <div class="form-group">
                            <label>Electricity (‚Çπ/month)</label>
                            <input type="number" id="shop-electricity" placeholder="0.00" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Gas/Fuel (‚Çπ/month)</label>
                            <input type="number" id="shop-gas" placeholder="0.00" step="0.01" value="0">
                        </div>
                        <div style="margin-top:8px;"><button class="btn btn-primary" onclick="saveShopOverhead()">Save Shop Costs</button></div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">üè≠ FACTORY LOCATION (SWEETS)</div>
                        <p style="font-size:11px; color:var(--color-text-secondary); margin-bottom:10px;">Costs for sweets only</p>
                        <div class="form-group">
                            <label>Electricity (‚Çπ/month)</label>
                            <input type="number" id="factory-electricity" placeholder="0.00" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Gas/Fuel (‚Çπ/month)</label>
                            <input type="number" id="factory-gas" placeholder="0.00" step="0.01" value="0">
                        </div>
                        <div style="margin-top:8px;"><button class="btn btn-primary" onclick="saveFactoryOverhead()">Save Factory Costs</button></div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">üë• STAFF PAYROLL (DEPARTMENT-WISE)</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                            <div style="background:var(--color-surface-light); padding:10px; border-radius:8px;">
                                <div style="font-size:11px; color:var(--color-text-secondary);">üçΩÔ∏è Restaurant Staff</div>
                                <div style="font-weight:700; font-size:14px;" id="restaurant-staff-count">0</div>
                                <div style="font-size:11px; color:var(--color-text-secondary);" id="restaurant-payroll">‚Çπ0/mo</div>
                            </div>
                            <div style="background:var(--color-surface-light); padding:10px; border-radius:8px;">
                                <div style="font-size:11px; color:var(--color-text-secondary);">üç¨ Sweets Staff</div>
                                <div style="font-weight:700; font-size:14px;" id="sweets-staff-count">0</div>
                                <div style="font-size:11px; color:var(--color-text-secondary);" id="sweets-payroll">‚Çπ0/mo</div>
                            </div>
                        </div>
                        <div style="margin-bottom:10px;">
                            <button class="btn btn-secondary" onclick="openModal('staff-modal')" style="margin-right:8px;">üë• Manage Staff</button>
                            <button class="btn btn-secondary" onclick="openModal('bulk-staff-modal')">üì§ Bulk Upload Staff</button>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Profit Target Settings</div>
                        <div class="form-group">
                            <label>Desired Profit Margin %</label>
                            <input type="number" id="profit-margin-target" placeholder="30" min="0" max="1000" step="0.1" value="30">
                        </div>
                        <div style="margin-top:8px;"><button class="btn btn-primary" onclick="saveProfitMargin()">Save Target</button></div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">‚òÅÔ∏è Cloud Sync (Supabase)</div>
                        <p style="font-size:11px; color:var(--color-text-secondary); margin-bottom:10px;">Sync your data to Supabase cloud storage. <strong>Note:</strong> Anon key only - enable RLS for production.</p>
                        <div class="form-group">
                            <label>Supabase Project URL</label>
                            <input type="text" id="supabase-url" placeholder="https://yourproject.supabase.co">
                        </div>
                        <div class="form-group">
                            <label>Supabase Anon Key</label>
                            <input type="password" id="supabase-key" placeholder="Your anon key">
                        </div>
                        <div class="form-group">
                            <label>Device ID (for sync)</label>
                            <input type="text" id="device-id" placeholder="my-device-123">
                        </div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                            <button class="btn btn-primary" onclick="cloudSyncSave()">‚òÅÔ∏è Save to Cloud</button>
                            <button class="btn btn-secondary" onclick="cloudSyncLoad()">‚¨áÔ∏è Load from Cloud</button>
                        </div>
                        <div id="sync-status-message" style="margin-top:8px; font-size:12px; color:var(--color-text-secondary);"></div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">üîÑ Manual Data Sync</div>
                        <p style="font-size:11px; color:var(--color-text-secondary); margin-bottom:10px;">Force save current data to cloud (useful for debugging)</p>
                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                            <button class="btn btn-primary" onclick="manualCloudSave()">üíæ Force Save Now</button>
                            <button class="btn btn-secondary" onclick="manualCloudLoad()">‚¨áÔ∏è Force Load Now</button>
                        </div>
                        <div id="manual-sync-status" style="margin-top:8px; font-size:12px; color:var(--color-text-secondary);"></div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">üì§ Bulk Import (CSV)</div>
                        <p style="font-size:11px; color:var(--color-text-secondary); margin-bottom:10px;">
                            Import hundreds of ingredients or recipes at once using CSV files
                        </p>
                        
                        <!-- Bulk Import Ingredients -->
                        <div style="margin-bottom:16px;">
                            <label style="font-size:13px; font-weight:600; margin-bottom:8px; display:block;">
                                Import Ingredients (CSV)
                            </label>
                            <p style="font-size:11px; color:var(--color-text-secondary); margin-bottom:8px;">
                                Format: <code>name,unit,price</code><br>
                                Example: <code>Paneer,kg,300</code><br>
                                <em>Note: Don't use commas in ingredient names</em>
                            </p>
                            <textarea 
                                id="bulk-ingredients-csv" 
                                placeholder="Paneer,kg,300&#10;Milk,L,60&#10;Sugar,kg,45&#10;Ghee,kg,550"
                                style="min-height:100px; font-family:monospace; font-size:12px;"
                            ></textarea>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <button class="btn btn-primary" onclick="bulkImportIngredients()">
                                    Import Ingredients
                                </button>
                                <button class="btn btn-secondary" onclick="downloadIngredientTemplate()">
                                    üì• Download Template
                                </button>
                            </div>
                        </div>
                        
                        <!-- Bulk Import Recipes -->
                        <div style="margin-bottom:16px;">
                            <label style="font-size:13px; font-weight:600; margin-bottom:8px; display:block;">
                                Import Recipes (CSV)
                            </label>
                            <p style="font-size:11px; color:var(--color-text-secondary); margin-bottom:8px;">
                                Format: <code>name,category,sellingPrice,wastage,dailyVolume</code><br>
                                Example: <code>Paneer Tikka,restaurant,250,10,50</code><br>
                                <em>Note: Don't use commas in recipe names</em>
                            </p>
                            <textarea 
                                id="bulk-recipes-csv" 
                                placeholder="Paneer Tikka,restaurant,250,10,50&#10;Gulab Jamun,sweets,80,8,100"
                                style="min-height:100px; font-family:monospace; font-size:12px;"
                            ></textarea>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <button class="btn btn-primary" onclick="bulkImportRecipes()">
                                    Import Recipes
                                </button>
                                <button class="btn btn-secondary" onclick="downloadRecipeTemplate()">
                                    üì• Download Template
                                </button>
                            </div>
                        </div>
                        
                        <!-- Import Status -->
                        <div id="bulk-import-status" style="margin-top:12px; padding:12px; border-radius:6px; display:none;"></div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">üîß Advanced: GitHub Gist Quick-Save</div>
                        <p style="font-size:11px; color:var(--color-text-secondary); margin-bottom:10px;"><strong>For developers only:</strong> Save a snapshot to GitHub Gist (requires personal access token).</p>
                        <div class="form-group">
                            <label>GitHub Personal Access Token (gist scope)</label>
                            <input type="password" id="github-token" placeholder="ghp_...">
                        </div>
                        <div style="margin-top:8px;">
                            <button class="btn btn-secondary" onclick="saveToGitHubGist()">üìù Save to Gist</button>
                        </div>
                        <div id="gist-status-message" style="margin-top:8px; font-size:12px; color:var(--color-text-secondary);"></div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Bulk Upload Menu (Quick Setup Only)</div>
                        <p style="font-size:12px; color:var(--color-text-secondary); margin-bottom:8px;">Format: Dish Name, Category, Selling Price</p>
                        <p style="font-size:11px; color:var(--color-warning); margin-bottom:8px;"><strong>‚ö†Ô∏è Note:</strong> This creates recipes without ingredients. To track making costs and get accurate cost breakdown, add recipes individually in the Recipes tab with ingredients.</p>
                        <textarea id="bulk-upload-data" placeholder="Paneer Tikka,restaurant,250&#10;Gulab Jamun,sweets,80"></textarea>
                        <div style="margin-top:8px;"><button class="btn btn-primary" onclick="bulkUploadMenu()">Upload Menu</button></div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Data Management</div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <button class="btn btn-secondary" onclick="exportData()">üì• Export Backup</button>
                            <button class="btn btn-secondary" onclick="triggerImport()">üì§ Import Backup</button>
                            <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
                            <button class="btn btn-danger" onclick="clearAllData()">‚ö†Ô∏è Clear All Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('dashboard')">üìä<div>Dashboard</div></button>
            <button class="nav-item" onclick="switchTab('ingredients')">üì¶<div>Ingredients</div></button>
            <button class="nav-item" onclick="switchTab('recipes')">üçΩÔ∏è<div>Recipes</div></button>
            <button class="nav-item" onclick="switchTab('settings')">‚öôÔ∏è<div>Settings</div></button>
        </div>
    </div>

    <!-- Ingredient Selector Modal -->
    <div id="ingredient-selector-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <strong>Select Ingredients</strong>
                <button class="btn btn-secondary" onclick="closeModal('ingredient-selector-modal')">Close</button>
            </div>
            <div id="ingredient-selector-list"></div>
            <div style="margin-top:10px;">
                <button class="btn btn-primary" onclick="closeModal('ingredient-selector-modal')">Done</button>
            </div>
        </div>
    </div>

    <!-- Edit Ingredient Modal -->
    <div id="edit-ingredient-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <strong>Edit Ingredient</strong>
                <button class="btn btn-secondary" onclick="closeModal('edit-ingredient-modal')">Close</button>
            </div>
            <div class="form-group">
                <label>Ingredient Name</label>
                <input type="text" id="edit-ingredient-name" placeholder="e.g., Milk, Paneer, Sugar">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Unit</label>
                    <select id="edit-ingredient-unit">
                        <option value="kg">kg</option>
                        <option value="L">L</option>
                        <option value="gm">gm</option>
                        <option value="pc">pc</option>
                        <option value="box">box</option>
                        <option value="bottle">bottle</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Price per Unit (‚Çπ)</label>
                    <input type="number" id="edit-ingredient-price" placeholder="0.00" step="0.01">
                </div>
            </div>
            <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn btn-primary" onclick="updateIngredient()">Save Changes</button>
                <button class="btn btn-danger" onclick="deleteIngredientFromModal()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Recipe Modal -->
    <div id="edit-recipe-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <strong>Edit Recipe</strong>
                <button class="btn btn-secondary" onclick="closeModal('edit-recipe-modal')">Close</button>
            </div>
            <div class="form-group">
                <label>Selling Price (‚Çπ)</label>
                <input type="number" id="edit-recipe-selling-price" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label>Wastage %</label>
                <input type="number" id="edit-recipe-wastage" placeholder="0" min="0" max="100" step="0.1">
            </div>
            <div class="form-group">
                <label>Daily Production</label>
                <input type="number" id="edit-recipe-daily-volume" placeholder="50" min="1" step="1">
            </div>
            <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn btn-primary" onclick="updateRecipe()">Save</button>
                <button class="btn btn-danger" onclick="deleteRecipe()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staff-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <strong>Staff Payroll Management</strong>
                <button class="btn btn-secondary" onclick="closeModal('staff-modal')">Close</button>
            </div>

            <div style="display:grid; gap:8px; margin-bottom:12px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                    <input type="text" id="staff-name" placeholder="Name/ID">
                    <input type="tel" id="staff-phone" placeholder="Phone">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                    <select id="staff-department">
                        <option value="restaurant">üçΩÔ∏è Restaurant</option>
                        <option value="sweets">üç¨ Sweets</option>
                    </select>
                    <input type="text" id="staff-designation" placeholder="Designation">
                </div>
                <input type="number" id="staff-salary" placeholder="Monthly Salary" step="0.01">
                <button class="btn btn-secondary" onclick="addStaffMember()">Add Staff</button>
            </div>

            <div>
                <h3 style="font-size:14px; margin-bottom:8px;">Staff List</h3>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>Name</th><th>Dept</th><th>Salary</th><th>Phone</th><th>Action</th></tr></thead>
                        <tbody id="staff-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Staff -->
    <div id="bulk-staff-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <strong>Bulk Upload Staff</strong>
                <button class="btn btn-secondary" onclick="closeModal('bulk-staff-modal')">Close</button>
            </div>
            <div>
                <label style="font-size:12px;">Format: Name, Department, Designation, Phone, Monthly Salary</label>
                <textarea id="bulk-staff-data" placeholder="Chef Raj,restaurant,Head Chef,9876543210,30000&#10;Pastry Chef,sweets,Head Chef,9876543212,28000" style="min-height:120px; font-size:13px;"></textarea>
            </div>
            <div style="display:flex; gap:8px; margin-top:10px;">
                <button class="btn btn-primary" onclick="bulkUploadStaff()">Upload</button>
                <button class="btn btn-secondary" onclick="closeModal('bulk-staff-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // STORAGE KEYS + DEFAULTS
        const STORAGE_KEYS = {
            ingredients: 'restaurant_ingredients',
            recipes: 'restaurant_recipes',
            shop_overhead: 'restaurant_shop_overhead',
            factory_overhead: 'restaurant_factory_overhead',
            staff: 'restaurant_staff',
            profitMargin: 'restaurant_profit_margin'
        };
        const DEFAULT_PROFIT_MARGIN = 30;
        const UI_REFRESH_DELAY_MS = 100; // Delay before UI refresh to ensure data is ready

        // Safe parse helper. Only parse if raw string exists; fallback to provided default.
        function safeGetParsed(storageKey, fallback){
            try{
                const raw = localStorage.getItem(storageKey);
                if (!raw) return fallback;
                return JSON.parse(raw);
            }catch(err){
                console.warn('safeGetParsed() parse failed for', storageKey, err);
                return fallback;
            }
        }

        // Robust loadData
        function loadData(){
            const ingredients = safeGetParsed(STORAGE_KEYS.ingredients, {});
            const recipes = safeGetParsed(STORAGE_KEYS.recipes, {});
            const shop_overhead = safeGetParsed(STORAGE_KEYS.shop_overhead, { electricity:0, gas:0 });
            const factory_overhead = safeGetParsed(STORAGE_KEYS.factory_overhead, { electricity:0, gas:0 });
            const staff = safeGetParsed(STORAGE_KEYS.staff, {});
            const rawProfit = parseFloat(localStorage.getItem(STORAGE_KEYS.profitMargin));
            const profitMargin = isNaN(rawProfit) ? DEFAULT_PROFIT_MARGIN : rawProfit;
            return { ingredients, recipes, shop_overhead, factory_overhead, staff, profitMargin };
        }

        // Load ingredients from Supabase database
        async function loadIngredientsFromSupabase() {
            try {
                if (!window.DB || !window.DB.Ingredients) {
                    console.warn('DB.Ingredients not loaded yet');
                    return;
                }
                
                const result = await window.DB.Ingredients.list();
                
                if (result && result.data) {
                    // Clear existing ingredients
                    DATA.ingredients = {};
                    
                    // Convert Supabase format to app format
                    result.data.forEach(ing => {
                        DATA.ingredients[ing.id] = {
                            id: ing.id,
                            name: ing.name,
                            unit: ing.unit,
                            price: ing.price_per_unit
                        };
                    });
                    
                    console.log('‚úÖ Loaded', result.data.length, 'ingredients from Supabase');
                }
            } catch (error) {
                console.error('Error loading ingredients from Supabase:', error);
            }
        }

        // Validate data structure before saving/loading
        function validateData(data) {
            const validation = {
                valid: true,
                issues: []
            };
            
            try {
                // Check ingredients
                if (data.ingredients && typeof data.ingredients === 'object') {
                    Object.keys(data.ingredients).forEach(id => {
                        const ing = data.ingredients[id];
                        if (!ing || 
                            !ing.name || (typeof ing.name === 'string' && ing.name.trim() === '') ||
                            !ing.unit || (typeof ing.unit === 'string' && ing.unit.trim() === '') ||
                            typeof ing.price !== 'number') {
                            validation.valid = false;
                            validation.issues.push(`Invalid ingredient: ${id}`);
                        }
                    });
                }
                
                // Check recipes
                if (data.recipes && typeof data.recipes === 'object') {
                    Object.keys(data.recipes).forEach(id => {
                        const recipe = data.recipes[id];
                        if (!recipe || !recipe.name || (typeof recipe.name === 'string' && recipe.name.trim() === '')) {
                            validation.valid = false;
                            validation.issues.push(`Recipe ${id} missing name`);
                        }
                        if (!recipe.ingredients || !Array.isArray(recipe.ingredients)) {
                            validation.valid = false;
                            validation.issues.push(`Recipe ${id} has invalid ingredients array`);
                        }
                        if (typeof recipe.sellingPrice !== 'number') {
                            validation.valid = false;
                            validation.issues.push(`Recipe ${id} has invalid selling price`);
                        }
                    });
                }
                
                // Check staff
                if (data.staff && typeof data.staff === 'object') {
                    Object.keys(data.staff).forEach(id => {
                        const staff = data.staff[id];
                        if (!staff ||
                            !staff.name || (typeof staff.name === 'string' && staff.name.trim() === '') ||
                            !staff.department || (typeof staff.department === 'string' && staff.department.trim() === '') ||
                            typeof staff.salary !== 'number') {
                            validation.valid = false;
                            validation.issues.push(`Invalid staff: ${id}`);
                        }
                    });
                }
                
                console.log('Data validation:', validation.valid ? '‚úÖ PASSED' : '‚ùå FAILED');
                if (!validation.valid) {
                    console.warn('Validation issues:', validation.issues);
                }
                
                return validation;
            } catch (error) {
                console.error('Error during validation:', error);
                return { valid: false, issues: ['Validation error: ' + error.message] };
            }
        }

        function saveAllData(data){
            // Validate data before saving
            const validation = validateData(data);
            if (!validation.valid) {
                console.warn('‚ö†Ô∏è Saving potentially invalid data');
            }
            
            // CRITICAL: Create a deep clone to prevent mutation during async save
            // Use structuredClone if available (modern browsers), fallback to JSON method
            const dataSnapshot = (typeof structuredClone !== 'undefined') 
                ? structuredClone(data) 
                : JSON.parse(JSON.stringify(data));
            
            // Save to localStorage
            try {
                localStorage.setItem(STORAGE_KEYS.ingredients, JSON.stringify(data.ingredients));
                localStorage.setItem(STORAGE_KEYS.recipes, JSON.stringify(data.recipes));
                localStorage.setItem(STORAGE_KEYS.shop_overhead, JSON.stringify(data.shop_overhead));
                localStorage.setItem(STORAGE_KEYS.factory_overhead, JSON.stringify(data.factory_overhead));
                localStorage.setItem(STORAGE_KEYS.staff, JSON.stringify(data.staff));
                localStorage.setItem(STORAGE_KEYS.profitMargin, (data.profitMargin||DEFAULT_PROFIT_MARGIN).toString());
                
                console.log('üíæ Data saved to localStorage:', {
                    ingredients: Object.keys(data.ingredients || {}).length,
                    recipes: Object.keys(data.recipes || {}).length,
                    staff: Object.keys(data.staff || {}).length
                });
            } catch (error) {
                console.error('‚ùå Error saving to localStorage:', error);
            }
            
            // Auto-save to cloud if authenticated (debounced) with snapshot
            if (window.Auth && window.Auth.isAuthenticated()) {
                clearTimeout(window.autoSaveTimeout);
                window.autoSaveTimeout = setTimeout(() => {
                    if (typeof window.saveUserData === 'function') {
                        // CRITICAL FIX: Pass snapshot instead of relying on global DATA
                        window.saveUserData(dataSnapshot).catch(err => {
                            console.error('Auto-save to cloud failed:', err);
                            // Retry once after 5 seconds
                            setTimeout(() => {
                                console.log('üîÑ Retrying cloud save...');
                                window.saveUserData(dataSnapshot).catch(retryErr => {
                                    console.error('‚ùå Retry also failed:', retryErr);
                                });
                            }, 5000);
                        });
                    }
                }, 2000); // Debounce for 2 seconds
            }
        }

        // App state
        let DATA = loadData();
        let currentRecipeIngredients = []; // temp list during recipe creation
        let selectedEditRecipeId = null;

        // Utilities
        function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
        function formatCurrency(n){ return '‚Çπ' + (isNaN(n) ? '0.00' : Number(n).toFixed(2)); }

        // ------------------ RENDER FUNCTIONS ------------------
        function updateDashboard(){
            const recipesCount = Object.keys(DATA.recipes || {}).length;
            const staffCount = Object.keys(DATA.staff || {}).length;
            document.getElementById('stat-recipes').innerText = recipesCount;
            document.getElementById('stat-total-staff').innerText = staffCount;

            // avg profit: compute simple average (selling - cost)/selling * 100
            const recipeVals = Object.values(DATA.recipes || {});
            let avgProfit = 0, red = 0;
            recipeVals.forEach(r => {
                const cost = computeRecipeCost(r);
                const profitPct = r.sellingPrice ? ((r.sellingPrice - cost)/r.sellingPrice)*100 : 0;
                avgProfit += profitPct;
                if (profitPct < (DATA.profitMargin || DEFAULT_PROFIT_MARGIN)) red++;
            });
            avgProfit = recipeVals.length ? (avgProfit/recipeVals.length) : 0;
            document.getElementById('stat-avg-profit').innerText = avgProfit.toFixed(1) + '%';
            document.getElementById('stat-red-dishes').innerText = red;
        }

        function renderIngredientsTable(){
            const tbody = document.getElementById('ingredients-table-body');
            tbody.innerHTML = '';
            const ingredients = DATA.ingredients || {};
            const keys = Object.keys(ingredients);
            if (keys.length === 0){
                document.getElementById('ingredients-empty').style.display = 'block';
            } else {
                document.getElementById('ingredients-empty').style.display = 'none';
            }
            keys.forEach(id => {
                const ing = ingredients[id];
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${escapeHtml(ing.name)}</td><td>${escapeHtml(ing.unit)}</td><td>${formatCurrency(ing.price)}</td>
                    <td><button class="btn btn-secondary" onclick="openEditIngredientModal('${id}')" style="margin-right:8px;">Edit</button><button class="btn btn-danger" onclick="deleteIngredient('${id}')">Delete</button></td>`;
                tbody.appendChild(tr);
            });
            renderIngredientSelectorList();
        }

        function renderRecipesList(){
            const list = document.getElementById('recipes-list');
            list.innerHTML = '';
            const recipes = DATA.recipes || {};
            const keys = Object.keys(recipes);
            if (keys.length === 0){
                list.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üçΩÔ∏è</div><div class="empty-state-title">No recipes yet</div></div>`;
                return;
            }
            keys.forEach(id => {
                const r = recipes[id];
                const cost = computeRecipeCost(r);
                const profitPct = r.sellingPrice ? ((r.sellingPrice - cost)/r.sellingPrice)*100 : 0;
                const row = document.createElement('div');
                row.className = 'dish-row';
                row.onclick = () => openEditRecipeModal(id);
                row.innerHTML = `<div class="dish-name">${escapeHtml(r.name)} <span style="font-size:12px; color:var(--color-text-secondary); margin-left:8px;">(${escapeHtml(r.category)})</span></div>
                    <div class="dish-details">
                        <div><div class="detail-item"><span class="detail-label">Cost</span><span class="detail-value">${formatCurrency(cost)}</span></div></div>
                        <div><div class="detail-item"><span class="detail-label">Selling</span><span class="detail-value">${formatCurrency(r.sellingPrice||0)}</span></div></div>
                    </div>
                    <div class="profit-margin ${profitPct>=0?'positive':''}" style="margin-top:8px;">Profit ${profitPct.toFixed(1)}%</div>`;
                list.appendChild(row);
            });
        }

        // Ingredient selector (modal) list
        function renderIngredientSelectorList(){
            const container = document.getElementById('ingredient-selector-list');
            container.innerHTML = '';
            const ingredients = DATA.ingredients || {};
            const keys = Object.keys(ingredients);
            if (keys.length === 0){
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div class="empty-state-title">No ingredients available</div></div>';
                return;
            }
            keys.forEach(id => {
                const ing = ingredients[id];
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.alignItems = 'center';
                wrapper.style.justifyContent = 'space-between';
                wrapper.style.padding = '8px';
                wrapper.style.borderBottom = '1px solid var(--color-border)';
                wrapper.innerHTML = `<div style="flex:1;">
                        <div style="font-weight:600">${escapeHtml(ing.name)} <small style="color:var(--color-text-secondary);">(${escapeHtml(ing.unit)})</small></div>
                        <div style="font-size:12px; color:var(--color-text-secondary)">${formatCurrency(ing.price)} per ${escapeHtml(ing.unit)}</div>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input type="number" min="0" placeholder="qty" style="width:80px; padding:6px;" id="sel-${id}-qty">
                        <button class="btn btn-primary" onclick="selectIngredientForRecipe('${id}')">Add</button>
                    </div>`;
                container.appendChild(wrapper);
            });
        }

        // Staff render
        function renderStaffTable(){
            const tbody = document.getElementById('staff-table-body');
            tbody.innerHTML = '';
            const staff = DATA.staff || {};
            const keys = Object.keys(staff);
            keys.forEach(id => {
                const s = staff[id];
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.department)}</td><td>${formatCurrency(s.salary)}</td><td>${escapeHtml(s.phone||'')}</td>
                    <td><button class="btn btn-secondary" onclick="removeStaff('${id}')">Remove</button></td>`;
                tbody.appendChild(tr);
            });
            // update payroll counts
            const staffVals = Object.values(staff);
            const restaurant = staffVals.filter(s=>s.department==='restaurant');
            const sweets = staffVals.filter(s=>s.department==='sweets');
            const restaurantPayroll = restaurant.reduce((a,b)=>a+(parseFloat(b.salary)||0),0);
            const sweetsPayroll = sweets.reduce((a,b)=>a+(parseFloat(b.salary)||0),0);
            document.getElementById('restaurant-staff-count').innerText = restaurant.length;
            document.getElementById('sweets-staff-count').innerText = sweets.length;
            document.getElementById('restaurant-payroll').innerText = formatCurrency(restaurantPayroll) + '/mo';
            document.getElementById('sweets-payroll').innerText = formatCurrency(sweetsPayroll) + '/mo';
            document.getElementById('stat-total-staff').innerText = keys.length;
        }

        // ------------------ CORE FUNCTIONALITY ------------------
        // Ingredients
        async function addIngredient(){
            const name = document.getElementById('ingredient-name').value.trim();
            const unit = document.getElementById('ingredient-unit').value;
            const price = parseFloat(document.getElementById('ingredient-price').value);
            
            if (!name || isNaN(price)) { 
                alert('Please enter valid name and price'); 
                return; 
            }
            
            try {
                // Use Supabase DB module
                const result = await window.DB.Ingredients.create({
                    name: name,
                    unit: unit,
                    price_per_unit: price
                });
                
                // Update local DATA object for backward compatibility
                DATA.ingredients[result.data.id] = {
                    id: result.data.id,
                    name: result.data.name,
                    unit: result.data.unit,
                    price: result.data.price_per_unit
                };
                
                // Update localStorage for offline compatibility
                saveAllData(DATA);
                
                // Clear form after successful addition
                document.getElementById('ingredient-name').value = '';
                document.getElementById('ingredient-unit').value = 'kg';
                document.getElementById('ingredient-price').value = '';
                
                renderIngredientsTable();
                
            } catch (error) {
                console.error('Error adding ingredient:', error);
                alert(error.userMessage || error.message || 'Failed to add ingredient');
            }
        }

        async function deleteIngredient(id){
            if (!confirm('Delete ingredient?')) return;
            
            try {
                // Use Supabase DB module
                await window.DB.Ingredients.delete(id);
                
                // Update local DATA object
                delete DATA.ingredients[id];
                
                // Update localStorage for offline compatibility
                saveAllData(DATA);
                
                renderIngredientsTable();
                
            } catch (error) {
                console.error('Error deleting ingredient:', error);
                alert(error.userMessage || error.message || 'Failed to delete ingredient');
            }
        }

        let selectedEditIngredientId = null;

        function openEditIngredientModal(id){
            const ing = DATA.ingredients[id];
            if (!ing) return;
            selectedEditIngredientId = id;
            document.getElementById('edit-ingredient-name').value = ing.name || '';
            document.getElementById('edit-ingredient-unit').value = ing.unit || 'kg';
            document.getElementById('edit-ingredient-price').value = ing.price || '';
            openModal('edit-ingredient-modal');
        }

        async function updateIngredient(){
            if (!selectedEditIngredientId) return;
            
            const name = document.getElementById('edit-ingredient-name').value.trim();
            const unit = document.getElementById('edit-ingredient-unit').value;
            const price = parseFloat(document.getElementById('edit-ingredient-price').value);
            
            if (!name || isNaN(price)) { 
                alert('Please enter valid name and price'); 
                return; 
            }
            
            try {
                await window.DB.Ingredients.update(selectedEditIngredientId, {
                    name: name,
                    unit: unit,
                    price_per_unit: price
                });
                
                // Update local DATA
                DATA.ingredients[selectedEditIngredientId] = { 
                    id: selectedEditIngredientId, 
                    name, 
                    unit, 
                    price 
                };
                
                // Update localStorage for offline compatibility
                saveAllData(DATA);
                
                renderIngredientsTable();
                closeModal('edit-ingredient-modal');
                
            } catch (error) {
                console.error('Error updating ingredient:', error);
                alert(error.userMessage || error.message || 'Failed to update ingredient');
            }
        }

        async function deleteIngredientFromModal(){
            if (!selectedEditIngredientId) return;
            if (!confirm('Delete this ingredient?')) return;
            
            try {
                await window.DB.Ingredients.delete(selectedEditIngredientId);
                delete DATA.ingredients[selectedEditIngredientId];
                
                // Update localStorage for offline compatibility
                saveAllData(DATA);
                
                renderIngredientsTable();
                closeModal('edit-ingredient-modal');
            } catch (error) {
                console.error('Error deleting ingredient:', error);
                alert(error.userMessage || error.message || 'Failed to delete ingredient');
            }
        }


        // Open ingredient selector
        function openIngredientSelector(){
            renderIngredientSelectorList();
            openModal('ingredient-selector-modal');
        }

        function selectIngredientForRecipe(ingredientId){
            const qtyEl = document.getElementById(`sel-${ingredientId}-qty`);
            const qty = parseFloat(qtyEl ? qtyEl.value : 0);
            if (!qty || qty <= 0){ alert('Enter quantity'); return; }
            const ing = DATA.ingredients[ingredientId];
            if (!ing) { alert('Ingredient not found'); return; }
            // Push to current recipe list
            currentRecipeIngredients.push({ id: ingredientId, qty, name: ing.name, unit: ing.unit, price: ing.price });
            renderRecipeIngredientsPreview();
            // clear input
            if (qtyEl) qtyEl.value = '';
        }

        function renderRecipeIngredientsPreview(){
            const container = document.getElementById('recipe-ingredients-list');
            container.innerHTML = '';
            currentRecipeIngredients.forEach((it, idx) => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.padding = '8px';
                row.style.border = '1px solid var(--color-border)';
                row.style.borderRadius = '8px';
                row.style.marginBottom = '8px';
                row.innerHTML = `<div>
                    <div style="font-weight:700">${escapeHtml(it.name)} <small style="color:var(--color-text-secondary)">(${escapeHtml(it.unit)})</small></div>
                    <div style="font-size:12px; color:var(--color-text-secondary)">${it.qty} √ó ${formatCurrency(it.price)} = ${formatCurrency(it.qty * it.price)}</div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-secondary" onclick="removeRecipeIngredient(${idx})">Remove</button>
                </div>`;
                container.appendChild(row);
            });
            updateRecipePreviewCosts();
        }

        function removeRecipeIngredient(index){
            currentRecipeIngredients.splice(index,1);
            renderRecipeIngredientsPreview();
        }

        // Compute recipe cost (raw + wastage + simple labour/utilities allocation)
        function computeRecipeCost(recipe){
            // recipe may be stored with ingredients array or be a created recipe object
            const ingredients = recipe.ingredients || [];
            const rawCost = ingredients.reduce((sum, it) => {
                const price = (it.price === undefined) ? (DATA.ingredients[it.id]?.price || 0) : it.price;
                const qty = parseFloat(it.qty) || 0;
                return sum + (qty * price);
            }, 0);
            const wastagePct = parseFloat(recipe.wastage) || 0;
            const wastageCost = rawCost * (wastagePct/100);
            // naive labour/utilities allocation: distribute monthly overhead per dailyVolume
            const dailyVol = parseFloat(recipe.dailyVolume) || 1;
            // monthly staff payroll for department
            const staffVals = Object.values(DATA.staff || {});
            const totalPayroll = staffVals.reduce((a,b)=>a+(parseFloat(b.salary)||0),0);
            const shopOver = DATA.shop_overhead || { electricity:0, gas:0 };
            const factoryOver = DATA.factory_overhead || { electricity:0, gas:0 };
            // distribute monthly overhead across an assumed 30 days and across production volume
            const monthlyOverhead = ( (recipe.category==='sweets') ? (factoryOver.electricity||0)+(factoryOver.gas||0) : (shopOver.electricity||0)+(shopOver.gas||0) ) + totalPayroll;
            const perItemOverhead = (monthlyOverhead / 30) / Math.max(1, dailyVol);
            const labour = perItemOverhead * 0.6; // simple split
            const utilities = perItemOverhead * 0.4;
            const total = rawCost + wastageCost + labour + utilities;
            return total;
        }

        function updateRecipePreviewCosts(){
            const rawCost = currentRecipeIngredients.reduce((s,it)=>s + (it.qty * it.price), 0);
            const wastage = rawCost * (parseFloat(document.getElementById('recipe-wastage').value || 0)/100);
            
            // Calculate labour/utilities based on settings (same logic as computeRecipeCost)
            const category = document.getElementById('recipe-category').value;
            const dailyVol = parseFloat(document.getElementById('recipe-daily-volume').value) || 1;
            const staffVals = Object.values(DATA.staff || {});
            const totalPayroll = staffVals.reduce((a,b)=>a+(parseFloat(b.salary)||0),0);
            const shopOver = DATA.shop_overhead || { electricity:0, gas:0 };
            const factoryOver = DATA.factory_overhead || { electricity:0, gas:0 };
            const monthlyOverhead = ( (category==='sweets') ? (factoryOver.electricity||0)+(factoryOver.gas||0) : (shopOver.electricity||0)+(shopOver.gas||0) ) + totalPayroll;
            const perItemOverhead = (monthlyOverhead / 30) / Math.max(1, dailyVol);
            const labour = perItemOverhead * 0.6; // simple split
            const utilities = perItemOverhead * 0.4;
            
            const total = rawCost + wastage + labour + utilities;
            document.getElementById('preview-raw-cost').innerText = formatCurrency(rawCost);
            document.getElementById('preview-wastage-cost').innerText = formatCurrency(wastage);
            document.getElementById('preview-labour-cost').innerText = formatCurrency(labour);
            document.getElementById('preview-utilities-cost').innerText = formatCurrency(utilities);
            document.getElementById('preview-total-cost').innerText = formatCurrency(total);
        }

        // Save recipe
        function saveRecipe(){
            const name = document.getElementById('recipe-name').value.trim();
            const category = document.getElementById('recipe-category').value;
            const sellingPrice = parseFloat(document.getElementById('recipe-selling-price').value) || 0;
            const wastage = parseFloat(document.getElementById('recipe-wastage').value) || 0;
            const dailyVolume = parseFloat(document.getElementById('recipe-daily-volume').value) || 1;
            if (!name){ alert('Enter dish name'); return; }
            if (!currentRecipeIngredients.length){ if(!confirm('No ingredients added. Save recipe without ingredients?')) return; }
            const id = uid();
            // store simplified ingredient info (id, qty, price snapshot)
            const ingredients = currentRecipeIngredients.map(it => ({ id: it.id, qty: it.qty, price: it.price, name: it.name, unit: it.unit }));
            DATA.recipes[id] = { id, name, category, sellingPrice, wastage, dailyVolume, ingredients };
            saveAllData(DATA);
            // reset inputs
            document.getElementById('recipe-name').value = '';
            document.getElementById('recipe-selling-price').value = '';
            currentRecipeIngredients = [];
            renderRecipeIngredientsPreview();
            renderRecipesList();
            updateDashboard();
            alert('Recipe saved');
        }

        // Edit recipe modal
        function openEditRecipeModal(id){
            const r = DATA.recipes[id];
            if (!r) return;
            selectedEditRecipeId = id;
            document.getElementById('edit-recipe-selling-price').value = r.sellingPrice || '';
            document.getElementById('edit-recipe-wastage').value = r.wastage || '';
            document.getElementById('edit-recipe-daily-volume').value = r.dailyVolume || '';
            openModal('edit-recipe-modal');
        }
        function updateRecipe(){
            if (!selectedEditRecipeId) return;
            const r = DATA.recipes[selectedEditRecipeId];
            if (!r) return;
            r.sellingPrice = parseFloat(document.getElementById('edit-recipe-selling-price').value) || 0;
            r.wastage = parseFloat(document.getElementById('edit-recipe-wastage').value) || 0;
            r.dailyVolume = parseFloat(document.getElementById('edit-recipe-daily-volume').value) || 1;
            DATA.recipes[selectedEditRecipeId] = r;
            saveAllData(DATA);
            renderRecipesList();
            updateDashboard();
            closeModal('edit-recipe-modal');
            alert('Recipe updated');
        }
        function deleteRecipe(){
            if (!selectedEditRecipeId) return;
            if (!confirm('Delete this recipe?')) return;
            delete DATA.recipes[selectedEditRecipeId];
            saveAllData(DATA);
            renderRecipesList();
            updateDashboard();
            closeModal('edit-recipe-modal');
        }

        // ------------------ SHOP/FACTORY/PAYROLL ------------------
        function saveShopOverhead(){
            const el = document.getElementById('shop-electricity').value || 0;
            const gas = document.getElementById('shop-gas').value || 0;
            DATA.shop_overhead = { electricity: parseFloat(el)||0, gas: parseFloat(gas)||0 };
            saveAllData(DATA);
            alert('Shop overhead saved');
            updateDashboard();
        }
        function saveFactoryOverhead(){
            const el = document.getElementById('factory-electricity').value || 0;
            const gas = document.getElementById('factory-gas').value || 0;
            DATA.factory_overhead = { electricity: parseFloat(el)||0, gas: parseFloat(gas)||0 };
            saveAllData(DATA);
            alert('Factory overhead saved');
            updateDashboard();
        }
        function saveProfitMargin(){
            const val = parseFloat(document.getElementById('profit-margin-target').value);
            DATA.profitMargin = isNaN(val) ? DEFAULT_PROFIT_MARGIN : val;
            saveAllData(DATA);
            alert('Profit margin target saved');
            updateDashboard();
        }

        // ------------------ STAFF ------------------
        function addStaffMember(){
            const name = document.getElementById('staff-name').value.trim();
            const phone = document.getElementById('staff-phone').value.trim();
            const dept = document.getElementById('staff-department').value;
            const designation = document.getElementById('staff-designation').value.trim();
            const salary = parseFloat(document.getElementById('staff-salary').value) || 0;
            if (!name){ alert('Enter staff name'); return; }
            const id = uid();
            DATA.staff[id] = { id, name, phone, department: dept, designation, salary };
            saveAllData(DATA);
            renderStaffTable();
            document.getElementById('staff-name').value=''; document.getElementById('staff-phone').value=''; document.getElementById('staff-salary').value='';
            closeModal('staff-modal');
        }
        function removeStaff(id){
            if (!confirm('Remove staff?')) return;
            delete DATA.staff[id];
            saveAllData(DATA);
            renderStaffTable();
            updateDashboard();
        }
        function bulkUploadStaff(){
            const text = document.getElementById('bulk-staff-data').value.trim();
            if (!text) { alert('Paste bulk staff lines'); return; }
            const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
            lines.forEach(line => {
                const parts = line.split(',').map(p=>p.trim());
                if (parts.length < 5) return;
                const [name, department, designation, phone, salary] = parts;
                const id = uid();
                DATA.staff[id] = { id, name, phone, department, designation, salary: parseFloat(salary)||0 };
            });
            saveAllData(DATA);
            renderStaffTable();
            closeModal('bulk-staff-modal');
        }

        // ------------------ BULK MENU, EXPORT/IMPORT, CLEAR ------------------
        function bulkUploadMenu(){
            const text = document.getElementById('bulk-upload-data').value.trim();
            if (!text) { alert('Enter menu lines'); return; }
            const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
            lines.forEach(line=>{
                const parts = line.split(',').map(p=>p.trim());
                if (parts.length < 3) return;
                const [name, category, selling] = parts;
                const id = uid();
                DATA.recipes[id] = { id, name, category, sellingPrice: parseFloat(selling)||0, wastage:10, dailyVolume:50, ingredients:[] };
            });
            saveAllData(DATA);
            renderRecipesList();
            updateDashboard();
            alert('Bulk menu uploaded');
        }

        // ------------------ BULK IMPORT CSV ------------------
        function bulkImportIngredients() {
            const csv = document.getElementById('bulk-ingredients-csv').value.trim();
            
            if (!csv) {
                showImportStatus('error', '‚ùå Please enter CSV data');
                return;
            }
            
            try {
                const lines = csv.split('\n').filter(line => line.trim());
                let imported = 0;
                let skipped = 0;
                let errors = [];
                
                lines.forEach((line, index) => {
                    const [name, unit, price] = line.split(',').map(s => s.trim());
                    
                    // Validate
                    if (!name || !unit || !price) {
                        errors.push(`Line ${index + 1}: Missing fields`);
                        skipped++;
                        return;
                    }
                    
                    const priceNum = parseFloat(price);
                    if (isNaN(priceNum)) {
                        errors.push(`Line ${index + 1}: Invalid price "${price}"`);
                        skipped++;
                        return;
                    }
                    
                    // Add ingredient
                    const id = uid();
                    DATA.ingredients[id] = {
                        name: name,
                        unit: unit,
                        price: priceNum
                    };
                    
                    imported++;
                });
                
                // Save and refresh
                saveAllData(DATA);
                renderIngredientsTable();
                
                // Show status
                let message = `‚úÖ Imported ${imported} ingredients`;
                if (skipped > 0) {
                    message += `\n‚ö†Ô∏è Skipped ${skipped} lines`;
                }
                if (errors.length > 0 && errors.length <= 5) {
                    message += '\n\nErrors:\n' + errors.join('\n');
                }
                
                showImportStatus('success', message);
                
                // Clear input
                document.getElementById('bulk-ingredients-csv').value = '';
                
            } catch (error) {
                console.error('Bulk import error:', error);
                showImportStatus('error', '‚ùå Import failed: ' + error.message);
            }
        }

        function bulkImportRecipes() {
            const csv = document.getElementById('bulk-recipes-csv').value.trim();
            
            if (!csv) {
                showImportStatus('error', '‚ùå Please enter CSV data');
                return;
            }
            
            try {
                const lines = csv.split('\n').filter(line => line.trim());
                let imported = 0;
                let skipped = 0;
                let errors = [];
                
                lines.forEach((line, index) => {
                    const [name, category, sellingPrice, wastage, dailyVolume] = line.split(',').map(s => s.trim());
                    
                    // Validate
                    if (!name || !category || !sellingPrice) {
                        errors.push(`Line ${index + 1}: Missing required fields`);
                        skipped++;
                        return;
                    }
                    
                    const price = parseFloat(sellingPrice);
                    const waste = parseFloat(wastage || '10');
                    const volume = parseInt(dailyVolume || '50');
                    
                    if (isNaN(price)) {
                        errors.push(`Line ${index + 1}: Invalid price "${sellingPrice}"`);
                        skipped++;
                        return;
                    }
                    
                    if (!['restaurant', 'sweets'].includes(category)) {
                        errors.push(`Line ${index + 1}: Category must be "restaurant" or "sweets"`);
                        skipped++;
                        return;
                    }
                    
                    // Add recipe
                    const id = uid();
                    DATA.recipes[id] = {
                        name: name,
                        category: category,
                        sellingPrice: price,
                        wastagePercent: waste,
                        dailyVolume: volume,
                        ingredients: []  // User adds ingredients later
                    };
                    
                    imported++;
                });
                
                // Save and refresh
                saveAllData(DATA);
                renderRecipesList();
                updateDashboard();
                
                // Show status
                let message = `‚úÖ Imported ${imported} recipes`;
                if (skipped > 0) {
                    message += `\n‚ö†Ô∏è Skipped ${skipped} lines`;
                }
                if (errors.length > 0 && errors.length <= 5) {
                    message += '\n\nErrors:\n' + errors.join('\n');
                }
                
                showImportStatus('success', message);
                
                // Clear input
                document.getElementById('bulk-recipes-csv').value = '';
                
            } catch (error) {
                console.error('Bulk import error:', error);
                showImportStatus('error', '‚ùå Import failed: ' + error.message);
            }
        }

        function downloadIngredientTemplate() {
            const csv = `name,unit,price
Paneer,kg,300
Milk,L,60
Sugar,kg,45
Ghee,kg,550
Flour (Maida),kg,35
Oil,L,150
Cardamom,gm,10
Saffron,gm,5`;
            
            downloadCSV(csv, 'ingredients-template.csv');
        }

        function downloadRecipeTemplate() {
            const csv = `name,category,sellingPrice,wastage,dailyVolume
Paneer Tikka,restaurant,250,10,50
Butter Chicken,restaurant,300,12,40
Gulab Jamun,sweets,80,8,100
Rasgulla,sweets,90,10,80
Jalebi,sweets,120,15,60`;
            
            downloadCSV(csv, 'recipes-template.csv');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function showImportStatus(type, message) {
            const statusEl = document.getElementById('bulk-import-status');
            if (!statusEl) return;
            
            statusEl.style.display = 'block';
            statusEl.style.whiteSpace = 'pre-wrap';
            
            if (type === 'success') {
                statusEl.style.background = 'rgba(50,184,198,0.1)';
                statusEl.style.border = '1px solid var(--color-success)';
                statusEl.style.color = 'var(--color-success)';
            } else {
                statusEl.style.background = 'rgba(255,84,89,0.1)';
                statusEl.style.border = '1px solid var(--color-error)';
                statusEl.style.color = 'var(--color-error)';
            }
            
            statusEl.textContent = message;
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 10000);
        }

        function exportData(){
            const exportObj = { data: DATA, exported_at: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'gokulsweets_backup_' + Date.now() + '.json';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        }

        function triggerImport(){
            document.getElementById('import-file').click();
        }

        function importData(event){
            const file = (event && event.target && event.target.files && event.target.files[0]) || null;
            if (!file) { alert('No file selected'); return; }
            const reader = new FileReader();
            reader.onload = function(e){
                try{
                    const parsed = JSON.parse(e.target.result);
                    if (parsed && parsed.data){
                        DATA = parsed.data;
                        saveAllData(DATA);
                        renderIngredientsTable();
                        renderRecipesList();
                        renderStaffTable();
                        updateDashboard();
                        alert('Data imported');
                    } else {
                        alert('Invalid import file');
                    }
                }catch(err){ alert('Corrupt JSON'); }
            };
            reader.readAsText(file);
        }

        function clearAllData(){
            if (!confirm('Clear all saved data? This cannot be undone.')) return;
            Object.values(STORAGE_KEYS).forEach(k => localStorage.removeItem(k));
            DATA = loadData();
            currentRecipeIngredients = [];
            renderIngredientsTable();
            renderRecipesList();
            renderStaffTable();
            updateDashboard();
            alert('All data cleared');
        }

        // ------------------ MODALS & UI ------------------
        function openModal(id){
            const el = document.getElementById(id);
            if (el) el.classList.add('active');
        }
        function closeModal(id){
            const el = document.getElementById(id);
            if (el) el.classList.remove('active');
        }
        function openEditRecipeModalById(id){ openEditRecipeModal(id); }

        // Switch tab
        function switchTab(tab){
            // remove active on nav
            document.querySelectorAll('.bottom-nav .nav-item').forEach(btn => btn.classList.remove('active'));
            // set clicked
            const navs = { dashboard:0, ingredients:1, recipes:2, settings:3 };
            const idx = navs[tab] || 0;
            const btn = document.querySelectorAll('.bottom-nav .nav-item')[idx];
            if (btn) btn.classList.add('active');

            // show tab contents
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
        }

        // small escape html helper for safety from user input
        function escapeHtml(s){
            if (s === undefined || s === null) return '';
            return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
        }

        // remove staff helper referenced earlier
        function removeStaff(id){ if(confirm('Remove staff?')){ delete DATA.staff[id]; saveAllData(DATA); renderStaffTable(); updateDashboard(); } }

        // ------------------ INIT ------------------
        function initApp(){
            // populate UI inputs from DATA
            document.getElementById('profit-margin-target').value = DATA.profitMargin || DEFAULT_PROFIT_MARGIN;
            const so = DATA.shop_overhead || { electricity:0, gas:0 };
            document.getElementById('shop-electricity').value = so.electricity || 0;
            document.getElementById('shop-gas').value = so.gas || 0;
            const fo = DATA.factory_overhead || { electricity:0, gas:0 };
            document.getElementById('factory-electricity').value = fo.electricity || 0;
            document.getElementById('factory-gas').value = fo.gas || 0;

            // Auto-populate Supabase config if available
            if (window.AppConfig && window.AppConfig.supabase) {
                const supabaseUrl = document.getElementById('supabase-url');
                const supabaseKey = document.getElementById('supabase-key');
                
                if (window.AppConfig.supabase.url && !supabaseUrl.value) {
                    supabaseUrl.value = window.AppConfig.supabase.url;
                }
                if (window.AppConfig.supabase.anonKey && !supabaseKey.value) {
                    supabaseKey.value = window.AppConfig.supabase.anonKey;
                }
                
                // Auto-sync on load if configured
                if (window.AppConfig.supabase.autoSync && 
                    window.AppConfig.supabase.url && 
                    window.AppConfig.supabase.anonKey) {
                    console.log('Auto-sync enabled, attempting to load data from cloud...');
                    // Use requestIdleCallback or setTimeout to ensure UI is fully ready
                    if ('requestIdleCallback' in window) {
                        requestIdleCallback(() => autoLoadFromCloud());
                    } else {
                        setTimeout(() => autoLoadFromCloud(), 1000);
                    }
                }
            }

            renderIngredientsTable();
            renderRecipesList();
            renderStaffTable();
            updateDashboard();

            // update recipe preview on wastage / volume change
            ['recipe-wastage','recipe-daily-volume','recipe-category'].forEach(id=>{
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateRecipePreviewCosts);
            });
        }

        // Auto-load from cloud (silent, non-intrusive)
        async function autoLoadFromCloud() {
            try {
                const url = document.getElementById('supabase-url').value.trim();
                const key = document.getElementById('supabase-key').value.trim();
                const deviceId = document.getElementById('device-id').value.trim();
                
                if (!url || !key || !deviceId) {
                    console.log('Auto-sync skipped: missing credentials');
                    return;
                }
                
                await window.SupabaseSync.init(url, key);
                const result = await window.SupabaseSync.loadData(deviceId);
                
                if (result && result.payload) {
                    const payload = result.payload;
                    
                    // Validate payload (check for null and object type)
                    if (!payload || typeof payload !== 'object' || 
                        typeof payload.ingredients !== 'object' ||
                        typeof payload.recipes !== 'object') {
                        console.warn('Auto-sync: invalid data structure received');
                        return;
                    }
                    
                    // Update local data
                    DATA = {
                        ingredients: payload.ingredients || {},
                        recipes: payload.recipes || {},
                        shop_overhead: payload.shop_overhead || { electricity: 0, gas: 0 },
                        factory_overhead: payload.factory_overhead || { electricity: 0, gas: 0 },
                        staff: payload.staff || {},
                        profitMargin: payload.profitMargin || DEFAULT_PROFIT_MARGIN
                    };
                    saveAllData(DATA);
                    
                    // Re-render
                    renderIngredientsTable();
                    renderRecipesList();
                    renderStaffTable();
                    updateDashboard();
                    
                    console.log('Auto-sync successful: data loaded from cloud');
                } else {
                    console.log('Auto-sync: no cloud data found, using local data');
                }
            } catch (error) {
                console.warn('Auto-sync failed (non-critical):', error.message);
                // Silently continue with local data
            }
        }

        // ------------------ AUTHENTICATION & INIT ------------------
        
        // Initialize authentication system
        async function initAuthSystem() {
            console.log('Initializing authentication system...');
            
            // Get Supabase configuration
            const config = window.SupabaseConfig.getConfig();
            
            if (!config.isConfigured) {
                console.warn('Supabase not configured - authentication disabled');
                // Show app without authentication (legacy mode)
                window.AuthUI.hideApp();
                initApp();
                document.getElementById('app-container').style.display = 'flex';
                return;
            }

            try {
                // Initialize Auth system
                await window.Auth.init(config.url, config.anonKey);
                
                // Initialize Supabase sync client
                await window.SupabaseSync.init(config.url, config.anonKey);
                
                // Check for existing session
                const session = await window.Auth.getSession();
                
                if (session && session.user) {
                    // User is authenticated
                    console.log('User authenticated:', session.user.email);
                    
                    // Show main app
                    window.AuthUI.hideApp();
                    initApp();
                    document.getElementById('app-container').style.display = 'flex';
                    window.AuthUI.updateUserInfo(session.user.email);
                    
                    // Initialize real-time sync
                    if (window.SupabaseSync.isReady()) {
                        window.SupabaseSync.initRealtimeSync();
                    }
                    
                    // Load user data
                    await loadUserData(session.user.id);
                    
                    // Setup real-time sync for ingredients
                    setupIngredientsRealtimeSync();
                } else {
                    // No session - show login screen
                    console.log('No session found - showing login screen');
                    document.getElementById('app-container').style.display = 'none';
                    window.AuthUI.show();
                }
                
                // Listen for auth state changes
                window.Auth.onAuthStateChange(async (event, session) => {
                    console.log('Auth state changed:', event);
                    
                    if (event === 'SIGNED_IN' && session) {
                        await loadUserData(session.user.id);
                        setupIngredientsRealtimeSync();
                    } else if (event === 'SIGNED_OUT') {
                        clearLocalData();
                    }
                });
                
            } catch (error) {
                console.error('Auth initialization failed:', error);
                // Fallback to non-authenticated mode
                window.AuthUI.hideApp();
                initApp();
                document.getElementById('app-container').style.display = 'flex';
            }
        }

        // Deep merge utility function to properly merge nested objects
        function deepMerge(target, source) {
            // Handle null/undefined - use || to return {} if both are falsy
            // This ensures we always return a valid object for merging
            if (!source) return target || {};
            if (!target) return source || {};
            
            // If source is not an object, return it directly
            if (typeof source !== 'object' || Array.isArray(source)) {
                return source;
            }
            
            // Clone target to avoid mutations
            const result = { ...target };
            
            // Merge each property from source
            Object.keys(source).forEach(key => {
                const sourceValue = source[key];
                const targetValue = result[key];
                
                // If both are objects (but not arrays), merge recursively
                if (
                    sourceValue && 
                    typeof sourceValue === 'object' && 
                    !Array.isArray(sourceValue) &&
                    targetValue &&
                    typeof targetValue === 'object' &&
                    !Array.isArray(targetValue)
                ) {
                    result[key] = deepMerge(targetValue, sourceValue);
                } else {
                    // Otherwise, use source value (overwrites target)
                    result[key] = sourceValue;
                }
            });
            
            return result;
        }

        // Force load user data from cloud (called after login)
        async function loadUserData(userId) {
            if (!userId) {
                console.error('‚ùå No user ID provided to loadUserData');
                return;
            }
            
            try {
                console.log('üì• Loading user data for:', userId);
                
                // Get device ID
                const deviceId = getOrCreateDeviceId();
                
                // Load from cloud
                if (window.SupabaseSync && window.SupabaseSync.isReady()) {
                    const cloudData = await window.SupabaseSync.loadData(deviceId, userId);
                    
                    if (cloudData && cloudData.payload) {
                        console.log('‚úÖ Cloud data found, analyzing structure...');
                        console.log('Cloud payload keys:', Object.keys(cloudData.payload));
                        
                        // Get current local data for clean merge
                        const localData = loadData();
                        
                        // Count items in cloud data
                        const cloudIngredients = cloudData.payload.ingredients || {};
                        const cloudRecipes = cloudData.payload.recipes || {};
                        const cloudStaff = cloudData.payload.staff || {};
                        
                        console.log('Cloud data counts:', {
                            ingredients: Object.keys(cloudIngredients).length,
                            recipes: Object.keys(cloudRecipes).length,
                            staff: Object.keys(cloudStaff).length
                        });
                        
                        // DEEP MERGE: Properly merge nested objects
                        DATA = {
                            ingredients: deepMerge(localData.ingredients || {}, cloudIngredients),
                            recipes: deepMerge(localData.recipes || {}, cloudRecipes),
                            shop_overhead: cloudData.payload.shop_overhead || localData.shop_overhead || { electricity: 0, gas: 0 },
                            factory_overhead: cloudData.payload.factory_overhead || localData.factory_overhead || { electricity: 0, gas: 0 },
                            staff: deepMerge(localData.staff || {}, cloudStaff),
                            profitMargin: cloudData.payload.profitMargin || localData.profitMargin || DEFAULT_PROFIT_MARGIN
                        };
                        
                        // Verify merge succeeded
                        console.log('After merge counts:', {
                            ingredients: Object.keys(DATA.ingredients).length,
                            recipes: Object.keys(DATA.recipes).length,
                            staff: Object.keys(DATA.staff).length
                        });
                        
                        // Validate recipe data integrity
                        if (Object.keys(DATA.recipes).length > 0) {
                            console.log('‚úÖ Recipes loaded successfully');
                            Object.keys(DATA.recipes).forEach(recipeId => {
                                const recipe = DATA.recipes[recipeId];
                                console.log(`Recipe: ${recipe.name}, Ingredients: ${recipe.ingredients?.length || 0}`);
                            });
                        } else {
                            console.warn('‚ö†Ô∏è No recipes found in merged data');
                        }
                        
                        // Update localStorage with merged data
                        saveAllData(DATA);
                        
                        // Load ingredients from Supabase database
                        await loadIngredientsFromSupabase();
                        
                        // Refresh all UI elements with delay to ensure data is ready
                        setTimeout(() => {
                            updateDashboard();
                            renderIngredientsTable();
                            renderRecipesList();
                            renderStaffTable();
                            console.log('‚úÖ User data loaded and UI updated');
                        }, UI_REFRESH_DELAY_MS);
                        
                    } else {
                        console.log('‚ÑπÔ∏è No cloud data found, using local data');
                        
                        // Load from localStorage as fallback
                        const localData = loadData();
                        DATA = localData;
                        
                        // Load ingredients from Supabase database
                        await loadIngredientsFromSupabase();
                        
                        // Update UI with local data
                        updateDashboard();
                        renderIngredientsTable();
                        renderRecipesList();
                        renderStaffTable();
                    }
                } else {
                    console.warn('‚ö†Ô∏è Supabase not ready, using local data only');
                    
                    // Load from localStorage
                    const localData = loadData();
                    DATA = localData;
                    
                    // Update UI
                    updateDashboard();
                    renderIngredientsTable();
                    renderRecipesList();
                    renderStaffTable();
                }
            } catch (error) {
                console.error('‚ùå Error loading user data:', error);
                console.error('Error stack:', error.stack);
                
                // Don't throw - use local data as fallback
                console.log('‚ÑπÔ∏è Falling back to local data due to error');
                
                try {
                    const localData = loadData();
                    DATA = localData;
                    
                    updateDashboard();
                    renderIngredientsTable();
                    renderRecipesList();
                    renderStaffTable();
                } catch (fallbackError) {
                    console.error('‚ùå Even fallback failed:', fallbackError);
                }
            }
        }

        // Store channel reference for cleanup
        let ingredientsRealtimeChannel = null;

        // Setup real-time sync for ingredients table
        function setupIngredientsRealtimeSync() {
            try {
                if (!window.DB || !window.DB.Base) {
                    console.warn('‚ö†Ô∏è DB.Base not loaded yet');
                    return;
                }
                
                const client = window.DB.Base.getClient();
                if (!client) {
                    console.warn('‚ö†Ô∏è Supabase client not initialized');
                    return;
                }
                
                // Unsubscribe from existing channel if any
                if (ingredientsRealtimeChannel) {
                    ingredientsRealtimeChannel.unsubscribe();
                }
                
                // Subscribe to ingredients changes
                ingredientsRealtimeChannel = client.channel('ingredients_changes')
                    .on('postgres_changes', 
                        { 
                            event: '*', 
                            schema: 'public', 
                            table: 'ingredients' 
                        }, 
                        (payload) => {
                            console.log('üîî Ingredient changed:', payload);
                            // Reload ingredients from Supabase
                            loadIngredientsFromSupabase().then(() => {
                                renderIngredientsTable();
                            }).catch(error => {
                                console.error('‚ùå Failed to reload ingredients after real-time update:', error);
                            });
                        }
                    )
                    .subscribe();
                
                console.log('‚úÖ Subscribed to ingredients real-time updates');
            } catch (error) {
                console.error('‚ùå Failed to setup ingredients real-time sync:', error);
            }
        }

        // Save user data to Supabase (called automatically when data changes)
        async function saveUserData(dataSnapshot = null) {
            try {
                const user = window.Auth.getCurrentUser();
                if (!user) {
                    console.warn('‚ö†Ô∏è No user authenticated, skipping cloud save');
                    return { success: false, error: 'Not authenticated' };
                }
                
                const deviceId = getOrCreateDeviceId();
                
                // CRITICAL FIX: Use snapshot if provided, otherwise use current DATA
                // This prevents race conditions where DATA changes between saveAllData() call and cloud save
                const dataToSave = dataSnapshot || DATA;
                
                // Validate before saving
                const recipeCount = Object.keys(dataToSave.recipes || {}).length;
                const ingredientCount = Object.keys(dataToSave.ingredients || {}).length;
                const staffCount = Object.keys(dataToSave.staff || {}).length;
                
                console.log('üíæ Saving to shared workspace...');
                console.log('üìä Payload preview:', {
                    ingredients: ingredientCount,
                    recipes: recipeCount,
                    staff: staffCount
                });
                
                // CRITICAL: Log recipe details to debug
                if (recipeCount > 0) {
                    console.log('‚úÖ Recipes being saved:', Object.keys(dataToSave.recipes));
                } else {
                    console.warn('‚ö†Ô∏è WARNING: Attempting to save with ZERO recipes!');
                    console.warn('‚ö†Ô∏è Current DATA.recipes:', Object.keys(DATA.recipes || {}).length);
                    console.warn('‚ö†Ô∏è This might be a race condition - aborting save');
                    
                    // SAFETY: Don't overwrite cloud data with empty recipes if we had recipes before
                    if (Object.keys(DATA.recipes || {}).length > 0) {
                        console.error("‚ùå ABORT: Preventing data loss - local has recipes but save payload doesn't");
                        return { success: false, error: 'Data consistency check failed' };
                    }
                }
                
                // Show sync indicator
                showSyncIndicator('saving');
                
                // Create payload with proper structure including synced_at timestamp
                const payload = {
                    ingredients: dataToSave.ingredients,
                    recipes: dataToSave.recipes,
                    shop_overhead: dataToSave.shop_overhead,
                    factory_overhead: dataToSave.factory_overhead,
                    staff: dataToSave.staff,
                    profitMargin: dataToSave.profitMargin,
                    synced_at: new Date().toISOString()
                };
                
                if (window.SupabaseSync && window.SupabaseSync.isReady()) {
                    const result = await window.SupabaseSync.saveData(deviceId, payload, user.id);
                    
                    if (result && result.success) {
                        console.log('‚úÖ User data saved to cloud');
                        showSyncIndicator('success');
                        return { success: true };
                    } else {
                        console.error('‚ùå Cloud save returned failure');
                        showSyncIndicator('error');
                        return { success: false, error: 'Save operation failed' };
                    }
                } else {
                    console.warn('‚ö†Ô∏è Supabase not ready, data saved locally only');
                    showSyncIndicator('error');
                    return { success: false, error: 'Supabase not ready' };
                }
            } catch (error) {
                console.error('‚ùå Error saving to cloud:', error);
                console.error('Error stack:', error.stack);
                showSyncIndicator('error');
                return { success: false, error: error.message };
            }
        }

        // Show sync status indicator
        function showSyncIndicator(status) {
            let indicator = document.getElementById('sync-indicator');
            
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'sync-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    padding: 10px 16px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    z-index: 9999;
                    transition: opacity 0.3s, transform 0.3s;
                `;
                document.body.appendChild(indicator);
            }
            
            if (status === 'saving') {
                indicator.style.background = '#3b82f6';
                indicator.style.color = 'white';
                indicator.innerHTML = '<span class="spinning">‚è≥</span><span>Saving...</span>';
                indicator.style.opacity = '1';
                indicator.style.transform = 'translateY(0)';
            } else if (status === 'success') {
                indicator.style.background = '#10b981';
                indicator.style.color = 'white';
                indicator.innerHTML = '<span>‚úÖ</span><span>Saved</span>';
                indicator.style.opacity = '1';
                indicator.style.transform = 'translateY(0)';
                
                // Hide after 2 seconds
                setTimeout(() => {
                    indicator.style.opacity = '0';
                    indicator.style.transform = 'translateY(10px)';
                }, 2000);
            } else if (status === 'error') {
                indicator.style.background = '#ef4444';
                indicator.style.color = 'white';
                indicator.innerHTML = '<span>‚ùå</span><span>Save failed</span>';
                indicator.style.opacity = '1';
                indicator.style.transform = 'translateY(0)';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    indicator.style.opacity = '0';
                    indicator.style.transform = 'translateY(10px)';
                }, 3000);
            }
        }

        // Manual cloud save for debugging
        async function manualCloudSave() {
            const statusEl = document.getElementById('manual-sync-status');
            if (!statusEl) return;
            
            statusEl.style.color = 'var(--color-warning)';
            statusEl.textContent = '‚è≥ Saving...';
            
            try {
                // Create snapshot to maintain consistency with automatic save
                // Use structuredClone if available (modern browsers), fallback to JSON method
                const dataSnapshot = (typeof structuredClone !== 'undefined') 
                    ? structuredClone(DATA) 
                    : JSON.parse(JSON.stringify(DATA));
                const result = await window.saveUserData(dataSnapshot);
                
                if (result && result.success) {
                    statusEl.style.color = 'var(--color-success)';
                    statusEl.textContent = `‚úÖ Saved! Recipes: ${Object.keys(DATA.recipes || {}).length}, Ingredients: ${Object.keys(DATA.ingredients || {}).length}`;
                } else {
                    statusEl.style.color = 'var(--color-error)';
                    statusEl.textContent = '‚ùå Save failed: ' + (result.error || 'Unknown error');
                }
            } catch (error) {
                statusEl.style.color = 'var(--color-error)';
                statusEl.textContent = '‚ùå Error: ' + error.message;
            }
        }

        // Manual cloud load for debugging
        async function manualCloudLoad() {
            const statusEl = document.getElementById('manual-sync-status');
            if (!statusEl) return;
            
            statusEl.style.color = 'var(--color-warning)';
            statusEl.textContent = '‚è≥ Loading...';
            
            try {
                const user = window.Auth.getCurrentUser();
                if (!user) {
                    statusEl.style.color = 'var(--color-error)';
                    statusEl.textContent = '‚ùå Not authenticated';
                    return;
                }
                
                await window.loadUserData(user.id);
                
                statusEl.style.color = 'var(--color-success)';
                statusEl.textContent = `‚úÖ Loaded! Recipes: ${Object.keys(DATA.recipes || {}).length}, Ingredients: ${Object.keys(DATA.ingredients || {}).length}`;
                
                // Refresh UI
                updateDashboard();
                renderDashboard();
                renderRecipesList();
                renderIngredientsTable();
                renderStaffTable();
            } catch (error) {
                statusEl.style.color = 'var(--color-error)';
                statusEl.textContent = '‚ùå Error: ' + error.message;
            }
        }

        // Initialize user data for new signups
        async function initializeUserData(userId) {
            console.log('üÜï Initializing data for new user:', userId);
            
            // Use existing local data if any, otherwise start fresh
            const currentData = loadData();
            
            // Save initial data to cloud
            if (window.SupabaseSync && window.SupabaseSync.isReady()) {
                try {
                    const deviceId = getOrCreateDeviceId();
                    
                    await window.SupabaseSync.saveData(deviceId, currentData, userId);
                    console.log('‚úÖ Initial data saved to cloud');
                } catch (error) {
                    console.error('‚ùå Error initializing cloud data:', error);
                }
            }
        }

        // Called on logout to handle local data cleanup
        // Note: This intentionally preserves localStorage to avoid data loss
        // when users switch accounts or re-login. The real cleanup happens
        // on the next login when cloud data is loaded.
        function clearLocalData() {
            console.log('üóëÔ∏è Handling logout data cleanup...');
            
            // Unsubscribe from real-time channels
            if (ingredientsRealtimeChannel) {
                ingredientsRealtimeChannel.unsubscribe();
                ingredientsRealtimeChannel = null;
                console.log('‚úÖ Unsubscribed from ingredients real-time updates');
            }
            
            // Don't actually clear localStorage - preserve it for next login
            // This prevents data loss if user immediately logs back in
            console.log('‚ÑπÔ∏è Local storage preserved for next login');
        }

        // Make saveUserData available globally for auto-sync
        window.loadUserData = loadUserData;
        window.initializeUserData = initializeUserData;
        window.clearLocalData = clearLocalData;
        window.saveUserData = saveUserData;

        // Note: Data is auto-saved with 1-second debounce after changes
        // This ensures data is synced to cloud quickly without needing beforeunload
        // localStorage is always updated immediately, providing offline persistence

        // run init once DOM ready
        document.addEventListener('DOMContentLoaded', initAuthSystem);

        // ------------------ PWA SERVICE WORKER REGISTRATION ------------------
        let newWorker = null;
        let updateCheckInterval = null;

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration);

                    // Check for updates periodically (every 60 seconds)
                    updateCheckInterval = setInterval(() => {
                        registration.update().catch(err => {
                            console.error('Service Worker update check failed:', err);
                        });
                    }, 60000);

                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('üîÑ New version available, preparing to update...');
                                // Auto-update after showing brief notification
                                showUpdateNotification();
                                
                                // Auto-update after 3 seconds to give user awareness
                                setTimeout(() => {
                                    console.log('üîÑ Auto-updating to new version...');
                                    updateApp();
                                }, 3000);
                            }
                        });
                    });
                })
                .catch(err => {
                    console.error('Service Worker registration failed:', err);
                    // Clean up interval if registration fails
                    if (updateCheckInterval) {
                        clearInterval(updateCheckInterval);
                        updateCheckInterval = null;
                    }
                });

            // Listen for controller change (new SW activated)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('New service worker activated, reloading...');
                // Save data before reload
                if (window.Auth && window.Auth.isAuthenticated() && typeof saveUserData === 'function') {
                    saveUserData().then(() => {
                        window.location.reload();
                    }).catch(() => {
                        window.location.reload();
                    });
                } else {
                    window.location.reload();
                }
            });
        }

        function showUpdateBanner() {
            const banner = document.getElementById('update-banner');
            if (banner) banner.classList.add('show');
        }

        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #3b82f6;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>üîÑ</span>
                    <span>New version available! Updating...</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 2500);
        }

        function updateApp() {
            if (newWorker) {
                // Tell the new service worker to skip waiting
                newWorker.postMessage({ type: 'SKIP_WAITING' });
            }
        }

        // ------------------ CLOUD SYNC FUNCTIONS ------------------
        async function cloudSyncSave() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            const deviceId = document.getElementById('device-id').value.trim();
            const statusEl = document.getElementById('sync-status-message');

            if (!url || !key || !deviceId) {
                statusEl.innerHTML = '<span class="sync-status error">‚ùå Please fill all fields</span>';
                return;
            }

            try {
                statusEl.innerHTML = '<span style="color:var(--color-text-secondary);">‚è≥ Initializing...</span>';
                await window.SupabaseSync.init(url, key);
                
                statusEl.innerHTML = '<span style="color:var(--color-text-secondary);">‚è≥ Saving...</span>';
                const payload = {
                    ingredients: DATA.ingredients,
                    recipes: DATA.recipes,
                    shop_overhead: DATA.shop_overhead,
                    factory_overhead: DATA.factory_overhead,
                    staff: DATA.staff,
                    profitMargin: DATA.profitMargin,
                    synced_at: new Date().toISOString()
                };
                
                await window.SupabaseSync.saveData(deviceId, payload);
                statusEl.innerHTML = '<span class="sync-status success">‚úÖ Saved to cloud successfully!</span>';
            } catch (error) {
                console.error('Cloud sync save error:', error);
                statusEl.innerHTML = '<span class="sync-status error">‚ùå Error: ' + escapeHtml(error.message) + '</span>';
            }
        }

        async function cloudSyncLoad() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            const deviceId = document.getElementById('device-id').value.trim();
            const statusEl = document.getElementById('sync-status-message');

            if (!url || !key || !deviceId) {
                statusEl.innerHTML = '<span class="sync-status error">‚ùå Please fill all fields</span>';
                return;
            }

            if (!confirm('Load data from cloud? This will replace your current local data.')) {
                return;
            }

            try {
                statusEl.innerHTML = '<span style="color:var(--color-text-secondary);">‚è≥ Initializing...</span>';
                await window.SupabaseSync.init(url, key);
                
                statusEl.innerHTML = '<span style="color:var(--color-text-secondary);">‚è≥ Loading...</span>';
                const result = await window.SupabaseSync.loadData(deviceId);
                
                if (!result || !result.payload) {
                    statusEl.innerHTML = '<span class="sync-status error">‚ö†Ô∏è No data found for this device ID</span>';
                    return;
                }

                // Validate payload structure before assignment
                const payload = result.payload;
                if (!payload || typeof payload !== 'object') {
                    statusEl.innerHTML = '<span class="sync-status error">‚ùå Invalid data format received</span>';
                    return;
                }

                // Validate expected properties exist
                const hasValidStructure = (
                    typeof payload.ingredients === 'object' &&
                    typeof payload.recipes === 'object'
                );

                if (!hasValidStructure) {
                    statusEl.innerHTML = '<span class="sync-status error">‚ùå Data structure validation failed</span>';
                    return;
                }

                // Update local data
                DATA = {
                    ingredients: payload.ingredients || {},
                    recipes: payload.recipes || {},
                    shop_overhead: payload.shop_overhead || { electricity: 0, gas: 0 },
                    factory_overhead: payload.factory_overhead || { electricity: 0, gas: 0 },
                    staff: payload.staff || {},
                    profitMargin: payload.profitMargin || DEFAULT_PROFIT_MARGIN
                };
                saveAllData(DATA);
                
                // Re-render everything
                renderIngredientsTable();
                renderRecipesList();
                renderStaffTable();
                updateDashboard();
                
                // Repopulate settings inputs
                document.getElementById('profit-margin-target').value = DATA.profitMargin || DEFAULT_PROFIT_MARGIN;
                const so = DATA.shop_overhead || { electricity:0, gas:0 };
                document.getElementById('shop-electricity').value = so.electricity || 0;
                document.getElementById('shop-gas').value = so.gas || 0;
                const fo = DATA.factory_overhead || { electricity:0, gas:0 };
                document.getElementById('factory-electricity').value = fo.electricity || 0;
                document.getElementById('factory-gas').value = fo.gas || 0;
                
                statusEl.innerHTML = '<span class="sync-status success">‚úÖ Loaded from cloud! Synced at: ' + (result.updated_at || 'unknown') + '</span>';
            } catch (error) {
                console.error('Cloud sync load error:', error);
                statusEl.innerHTML = '<span class="sync-status error">‚ùå Error: ' + escapeHtml(error.message) + '</span>';
            }
        }

        // ------------------ GITHUB GIST SAVE (ADVANCED) ------------------
        async function saveToGitHubGist() {
            const token = document.getElementById('github-token').value.trim();
            const statusEl = document.getElementById('gist-status-message');

            if (!token) {
                statusEl.innerHTML = '<span class="sync-status error">‚ùå Please enter GitHub token</span>';
                return;
            }

            // Validate token format (GitHub tokens start with ghp_, gho_, ghs_, etc.)
            const validTokenPrefixes = ['ghp_', 'gho_', 'ghs_', 'ghu_', 'github_pat_'];
            const hasValidPrefix = validTokenPrefixes.some(prefix => token.startsWith(prefix));
            
            if (!hasValidPrefix) {
                statusEl.innerHTML = '<span class="sync-status error">‚ùå Invalid token format. GitHub tokens should start with ghp_, gho_, etc.</span>';
                return;
            }

            try {
                statusEl.innerHTML = '<span style="color:var(--color-text-secondary);">‚è≥ Creating gist...</span>';
                
                const payload = {
                    ingredients: DATA.ingredients,
                    recipes: DATA.recipes,
                    shop_overhead: DATA.shop_overhead,
                    factory_overhead: DATA.factory_overhead,
                    staff: DATA.staff,
                    profitMargin: DATA.profitMargin,
                    exported_at: new Date().toISOString()
                };

                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'token ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: 'Gokul Sweets backup - ' + new Date().toISOString(),
                        public: false,
                        files: {
                            'gokulsweets-backup.json': {
                                content: JSON.stringify(payload, null, 2)
                            }
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('GitHub API error: ' + response.status);
                }

                const data = await response.json();
                statusEl.innerHTML = '<span class="sync-status success">‚úÖ Saved to Gist! <a href="' + escapeHtml(data.html_url) + '" target="_blank" style="color:var(--color-primary);">View</a></span>';
            } catch (error) {
                console.error('GitHub Gist error:', error);
                statusEl.innerHTML = '<span class="sync-status error">‚ùå Error: ' + escapeHtml(error.message) + '</span>';
            }
        }

        // Generate a default device ID if none exists
        function getOrCreateDeviceId() {
            let deviceId = localStorage.getItem('app_device_id');
            if (!deviceId) {
                deviceId = 'device-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8);
                localStorage.setItem('app_device_id', deviceId);
            }
            return deviceId;
        }

        // Populate device ID on load
        window.addEventListener('DOMContentLoaded', () => {
            const deviceIdInput = document.getElementById('device-id');
            if (deviceIdInput && !deviceIdInput.value) {
                deviceIdInput.value = getOrCreateDeviceId();
            }
        });

        // Real-time sync integration
        (function() {
          'use strict';
          
          // Initialize real-time sync listener after authentication
          function setupRealtimeSync() {
            if (!window.SupabaseSync || !window.SupabaseSync.isReady()) {
              console.warn('‚ö†Ô∏è SupabaseSync not ready');
              return;
            }
            
            console.log('üîÑ Setting up real-time sync listener...');
            
            // Register callback for real-time updates
            window.SupabaseSync.onDataSync((eventType, newPayload) => {
              console.log('üîî Real-time data update received:', eventType);
              
              if (newPayload) {
                // Merge remote changes with local state
                DATA = {
                  ...DATA,
                  ...newPayload
                };
                
                // Update localStorage
                saveAllData(DATA);
                
                // Refresh current view
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                  const tabId = activeTab.id;
                  if (tabId === 'dashboard-tab') {
                    updateDashboard();
                  } else if (tabId === 'ingredients-tab') {
                    renderIngredientsTable();
                  } else if (tabId === 'recipes-tab') {
                    renderRecipesList();
                  } else if (tabId === 'settings-tab') {
                    renderStaffTable();
                  }
                }
                
                // Show sync notification
                showSyncNotification('Data synced from another user');
              }
            });
            
            console.log('‚úÖ Real-time sync listener registered');
          }
          
          // Show sync notification
          function showSyncNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: #10b981;
              color: white;
              padding: 12px 20px;
              border-radius: 8px;
              box-shadow: 0 4px 6px rgba(0,0,0,0.1);
              z-index: 10000;
              animation: slideIn 0.3s ease;
              font-size: 14px;
              font-weight: 600;
            `;
            notification.textContent = `üîÑ ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
              notification.style.animation = 'slideOut 0.3s ease';
              setTimeout(() => notification.remove(), 300);
            }, 3000);
          }
          
          // Setup on auth state change
          if (window.Auth) {
            window.Auth.onAuthStateChange((event, session) => {
              if (event === 'SIGNED_IN' && session) {
                console.log('‚úÖ User signed in, initializing real-time sync');
                // Initialize real-time sync
                if (window.SupabaseSync && window.SupabaseSync.isReady()) {
                  window.SupabaseSync.initRealtimeSync();
                  setupRealtimeSync();
                }
              } else if (event === 'SIGNED_OUT') {
                console.log('üõë User signed out, stopping real-time sync');
                if (window.SupabaseSync) {
                  window.SupabaseSync.stopRealtimeSync();
                }
              }
            });
          }
          
          // Add CSS animations
          const style = document.createElement('style');
          style.textContent = `
            @keyframes slideIn {
              from { transform: translateX(400px); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
              from { transform: translateX(0); opacity: 1; }
              to { transform: translateX(400px); opacity: 0; }
            }
          `;
          document.head.appendChild(style);
          
          console.log('‚úÖ Real-time sync integration loaded');
        })();
    </script>
    
    <!-- Load Supabase configuration -->
    <script src="./supabase-config.js"></script>
    
    <!-- Load Supabase client helper -->
    <script src="./supabase-client.js"></script>
    
    <!-- Load Authentication module -->
    <script src="./auth.js"></script>

    <!-- Load V2 Multi-Table Architecture Modules -->
    <!-- Database Layer -->
    <script src="./db/base.js"></script>
    <script src="./db/ingredients.js"></script>
    <script src="./db/recipes.js"></script>
    <script src="./db/staff.js"></script>
    <script src="./db/organizations.js"></script>
    <script src="./db/audit.js"></script>

    <!-- Sync Layer -->
    <script src="./sync/realtime.js"></script>
    <script src="./sync/offline-queue.js"></script>
    <script src="./sync/conflict-resolver.js"></script>
    <script src="./sync/sync-manager.js"></script>

    <!-- UI Layer -->
    <script src="./ui/toast.js"></script>
    <script src="./ui/error-handler.js"></script>
    <script src="./ui/save-indicator.js"></script>
    <script src="./ui/conflict-ui.js"></script>

    <!-- PWA Layer -->
    <script src="./pwa/update-manager.js"></script>

    <!-- Migration and Initialization -->
    <script src="./migration.js"></script>
    <script src="./app-init.js"></script>
</body>
</html>
